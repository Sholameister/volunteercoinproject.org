<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-DF0HYPGY7M"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date()); gtag('config', 'G-DF0HYPGY7M');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KYC Check & Signup</title>
  <style>
    body { background:#fdf2f8; font-family:'Segoe UI',sans-serif; text-align:center; padding:20px; }
    h2 { margin: 0 0 8px; }
    p { margin: 8px 0; }
    button, a.btn { background:#e60073; color:#fff; padding:12px 20px; border:none; border-radius:6px; font-size:16px; margin:10px; cursor:pointer; display:inline-block; text-decoration:none; }
    button:hover, a.btn:hover { background:#cc005f; }
    #kycStatus,#tierInfo { font-weight:bold; margin:10px 0; }

    .tier-badge { padding:4px 10px; border-radius:4px; font-weight:bold; display:inline-block; }
    .tier-1 { background:#ffe0e0; color:#c0392b }
    .tier-2 { background:#fff3cd; color:#856404 }
    .tier-3 { background:#d4edda; color:#155724 }

    .nav-button { display:inline-block; margin:8px; padding:10px 14px; border-radius:6px; background:#f3f4f6; text-decoration:none; color:#111827; font-size:14px; }

    /* iPhone note box */
    #iosNote { display:none; margin:20px auto; padding:14px; max-width:480px; border:2px solid #e53935; border-radius:8px; background:#fff3f3; color:#b71c1c; font-weight:600; font-size:15px; }

    /* Wallet: suggest install (optional for later) */
    #walletSuggest { margin:18px auto; padding:14px; max-width:520px; background:#fff; border:1px solid #eee; border-radius:10px; }
    .wallet-buttons { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .wallet-buttons a { border-radius:6px; padding:12px 16px; font-weight:700; }
    .btn-phantom { background:#6c2bd9; color:#fff; }
    .btn-solflare { background:#ff6a00; color:#fff; }
    .btn-outline { background:#fff; color:#333; border:1px solid #bbb; }

    ul { list-style:none; text-align:left; max-width:520px; margin:20px auto; padding:0; }
    ul li { margin:6px 0; }
  </style>
</head>
<body>
  <h2>Sign Up & KYC Verification</h2>
  <p style="font-style:italic;color:#333;">
    To unlock volunteer rewards, complete the KYC below. You can link a wallet later inside the volunteer logger.
  </p>

  <!-- KYC / Tier -->
  <p id="kycStatus">KYC: ‚è≥ Pending</p>
  <div id="tierInfo" class="tier-badge tier-1">Tier: 1</div>

  <!-- Blockpass (kept at top; opens in new tab) -->
  <div id="kycBlock" style="margin-top:12px;">
    <a id="startKycLink"
       href="https://verify-with.blockpass.org/?clientId=volunteer_coin_project_68f8b"
       target="_blank" rel="noopener">
      <button id="startKycBtn">Start / Continue KYC</button>
    </a>
  </div>

  <!-- Optional wallet suggestions (NOT required for signup) -->
  <div id="walletSuggest">
    <div style="font-weight:700; margin-bottom:8px;">Planning to connect a wallet later?</div>
    <div style="font-size:14px; color:#444; margin-bottom:10px;">
      Install a wallet now so you‚Äôre ready to receive rewards after KYC. (Optional at signup.)
    </div>
    <div class="wallet-buttons">
      <!-- iOS / Android app links -->
      <a class="btn btn-phantom"
         href="https://phantom.app/download"
         target="_blank" rel="noopener">Get Phantom</a>
      <a class="btn btn-solflare"
         href="https://solflare.com/download"
         target="_blank" rel="noopener">Get Solflare</a>
      <!-- Copy URL helper (if you want to open this page inside wallet later) -->
      <a id="copyUrlBtn" class="btn btn-outline" href="javascript:void(0)">Copy this page URL</a>
    </div>
    <div style="font-size:12px; color:#666; margin-top:8px;">
      Tip: On iPhone, you can open our site inside your wallet app‚Äôs built-in browser when you‚Äôre ready to log volunteer hours.
    </div>
  </div>

  <!-- üì± iPhone Safari note -->
  <div id="iosNote">
    üì± <strong>iPhone Users:</strong><br/>
    You can complete KYC in <strong>Safari</strong> today. Later, for the volunteer logger and camera uploads,
    you may open our site inside your wallet‚Äôs browser (Phantom/Solflare).
  </div>

  <!-- Rewards blurb -->
  <ul>
    <li>üíó SYNCM Rewards (example):</li>
    <li>‚Ä¢ Tier 1 ‚Äì 5 SYNCM/hr (basic signup)</li>
    <li>‚Ä¢ Tier 2 ‚Äì 10 SYNCM/hr (KYC + driver)</li>
    <li>‚Ä¢ Tier 3 ‚Äì 15 SYNCM/hr (KYC + 2 refs + 25+ hours)</li>
  </ul>

  <!-- Nav -->
  <a href="./login.html" class="nav-button" target="_blank" rel="noopener">Login Page</a>
  <a href="./index.html" class="nav-button" target="_blank" rel="noopener">Home Page</a>

  <!-- Libs / Modules (wallet modules removed on signup) -->
  <script type="module" src="./firebaseConfig.js"></script>
  <script type="module" src="./kycUtils.js"></script>

  <!-- Minimal helper: iOS notice + Copy URL -->
  <script>
    (function(){
      const isIOS = () => /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      document.addEventListener('DOMContentLoaded', () => {
        if (isIOS()) document.getElementById('iosNote').style.display = 'block';

        const copyBtn = document.getElementById('copyUrlBtn');
        copyBtn?.addEventListener('click', () => {
          const url = window.location.href;
          navigator.clipboard?.writeText(url).then(()=>{
            copyBtn.textContent='Copied ‚úì';
            setTimeout(()=> copyBtn.textContent='Copy this page URL', 1500);
          });
        });
      });
    })();
  </script>

  <!-- Optional: simple KYC polling hook (adjust to your existing kycUtils.js) -->
  <script type="module">
    import { db } from './firebaseConfig.js';
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import { doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
    // If your kycUtils.js already handles this, you can remove this block.

    const auth = getAuth();
    const kycStatusEl = document.getElementById('kycStatus');
    const tierInfoEl = document.getElementById('tierInfo');

    onAuthStateChanged(auth, async (user) => {
      if (!user) { kycStatusEl.textContent = 'KYC: Sign in first (email/password)'; return; }
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        await setDoc(ref, { kycTier: 1, walletAddress: null, updatedAt: serverTimestamp() }, { merge: true });
        tierInfoEl.className = 'tier-badge tier-1';
        tierInfoEl.textContent = 'Tier: 1';
        kycStatusEl.textContent = 'KYC: ‚è≥ Pending';
        return;
      }

      const data = snap.data() || {};
      const tier = Number(data.kycTier || 1);
      kycStatusEl.textContent = tier >= 2 ? 'KYC: ‚úÖ Verified' : 'KYC: ‚è≥ Pending';

      if (tier >= 3) { tierInfoEl.className = 'tier-badge tier-3'; tierInfoEl.textContent = 'Tier: 3'; }
      else if (tier >= 2) { tierInfoEl.className = 'tier-badge tier-2'; tierInfoEl.textContent = 'Tier: 2'; }
      else { tierInfoEl.className = 'tier-badge tier-1'; tierInfoEl.textContent = 'Tier: 1'; }
    });
  </script>
</body>
</html>
