<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-DF0HYPGY7M"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date()); gtag('config', 'G-DF0HYPGY7M');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Volunteer Logger</title>
  <style>
    body { background:#fffdfd; font-family:'Segoe UI',sans-serif; padding:20px; text-align:center }
    button, input[type="file"] { display:block; margin:10px auto; padding:12px; border-radius:6px; width:90%; max-width:420px; font-size:16px }
    button { background:#e60073; color:#fff; border:none; cursor:pointer }
    button:hover { background:#cc005f }
    .muted { color:#555; font-size:14px }
    #summaryBox { margin-top:20px; padding:12px; border:1px solid #ddd; border-radius:8px; background:#fafafa; display:none }
    #afterPhotosBox img { max-width:100px; margin:5px; border-radius:6px }
    .nav-button { display:inline-block; margin:8px; padding:10px 14px; border-radius:6px; background:#f3f4f6; text-decoration:none; color:#111827; font-size:14px; }

    /* Keep buttons in DOM for scripts, but hidden in UI */
    #startVolunteeringBtn, #stopVolunteeringBtn { display:none !important; }

    /* iOS wallet notice */
    #iosWalletNotice { display:none; margin:20px auto; padding:16px; max-width:520px; border:3px solid #e53935; border-radius:10px; background:#fff3f3; color:#b71c1c; font-weight:600; }
  </style>
</head>
<body>
  <h1>Volunteer Session Logger</h1>

  <!-- Status / gating -->
  <button id="connectWalletBtn" type="button">Connect Wallet</button>
  <p id="walletAddress">Wallet: Not Connected</p>
  <p id="kycStatus">KYC: ‚Äî</p>
  <p id="tierInfo">Tier: ‚Äî</p>
  <p id="tierNote" class="muted"></p>
  <p id="walletStatus" class="muted"></p>

  <!-- iOS guidance (shown only if on iPhone and not already in wallet browser) -->
  <div id="iosWalletNotice">
    üö® iPhone users: for camera uploads & wallet connect, open this page inside your wallet app (Phantom/Solflare) or use the buttons below.
    <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px;">
      <button id="openPhantomBtn" type="button" style="padding:10px 14px; border-radius:6px; border:none; background:#6c2bd9; color:#fff; font-weight:700;">Open in Phantom</button>
      <button id="openSolflareBtn" type="button" style="padding:10px 14px; border-radius:6px; border:2px solid #ff6a00; background:#fff; color:#ff6a00; font-weight:700;">Open in Solflare</button>
      <button id="copyUrlBtn" type="button" style="padding:10px 14px; border-radius:6px; border:1px solid #bbb; background:#fff; color:#333; font-weight:600;">Copy URL</button>
    </div>
  </div>

  <!-- Volunteering flow -->
  <h3>Before Volunteering: Take & Upload Photo</h3>
  <input type="file" id="beforePhoto" accept="image/*" capture="environment" disabled />
  <button id="startVolunteeringBtn" type="button" disabled>Start Volunteering</button>

  <h3>After Volunteering: Take & Upload Photo</h3>
  <input type="file" id="afterPhoto" accept="image/*" capture="environment" disabled />
  <button id="stopVolunteeringBtn" type="button" disabled>Stop Volunteering</button>

  <!-- Summary -->
  <div id="summaryBox">
    <h3>Volunteer Summary</h3>
    <p id="sessionTimes"></p>
    <p id="tokensEarned"></p>
    <p id="totalLVBTN"></p>
    <p id="usdValue"></p>
    <p id="walletSummary"></p>
  </div>

  <!-- Gallery -->
  <h4>Past Volunteering Experiences</h4>
  <div id="afterPhotosBox" style="display:flex;flex-wrap:wrap;gap:10px;"></div>

  <!-- Nav -->
  <a href="./login.html" class="nav-button" target="_blank" rel="noopener">Go to Login</a>
  <a href="./index.html" class="nav-button" target="_blank" rel="noopener">Go to Home</a>
  <a href="./501c3-approved.html" class="nav-button" target="_blank" rel="noopener">501(c)(3) Approval</a>

  <!-- On-screen error/status log (optional) -->
  <div id="statusBox" style="font:12px/1.35 system-ui; background:#eef6ff; border:1px solid #b6d4fe; padding:8px; border-radius:6px; margin:10px auto; max-width:520px; display:none"></div>
  <script>
    (function(){
      const box = document.getElementById('statusBox');
      const log = (m)=>{ const d=document.createElement('div'); d.textContent=m; box.appendChild(d); };
      window.addEventListener('error', e=>{ box.style.display='block'; log('Error: ' + (e.message||e.error)); });
      window.addEventListener('unhandledrejection', e=>{ box.style.display='block'; log('Promise: ' + (e.reason && e.reason.message || e.reason)); });
    })();
  </script>

  <!-- Scripts -->
  <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
  <script type="module" src="./firebaseConfig.js"></script>
  <script type="module" src="./kycUtils.js"></script>
  <script type="module" src="./connectWallet.js"></script>
  <script type="module" src="./loginLogic.js"></script>

  <!-- Gate by KYC tier: Tier 1 can ‚Äúpractice‚Äù w/o wallet; Tier 2+ must connect -->
  <script type="module">
    import { db } from './firebaseConfig.js';
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    const beforePhoto   = document.getElementById('beforePhoto');
    const afterPhoto    = document.getElementById('afterPhoto');
    const kycStatusEl   = document.getElementById('kycStatus');
    const tierInfoEl    = document.getElementById('tierInfo');
    const tierNoteEl    = document.getElementById('tierNote');
    const walletAddrEl  = document.getElementById('walletAddress');

    let walletAddress = null;

    // Listen for wallet connection event from connectWallet.js
    document.addEventListener('wallet:connected', (ev) => {
      walletAddress = (ev.detail && ev.detail.address) || null;
      walletAddrEl.textContent = walletAddress ? `Wallet: ${walletAddress}` : 'Wallet: Not Connected';

      // If Tier 2+, unlock beforePhoto only when wallet is connected
      if (tierInfoEl.dataset.tier && Number(tierInfoEl.dataset.tier) >= 2) {
        beforePhoto.disabled = !walletAddress;
        beforePhoto.style.opacity = walletAddress ? '1' : '0.6';
      }
    });

    onAuthStateChanged(getAuth(), async (user) => {
      if (!user) {
        kycStatusEl.textContent = 'KYC: Sign in first (email/password)';
        tierInfoEl.textContent  = 'Tier: ‚Äî';
        tierInfoEl.dataset.tier = '0';
        beforePhoto.disabled = true;
        afterPhoto.disabled  = true;
        return;
      }

      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      const data = snap.data() || {};
      const tier = Number(data.kycTier || 1);
      tierInfoEl.dataset.tier = String(tier);

      // Update UI labels
      if (tier >= 2) { kycStatusEl.textContent = 'KYC: ‚úÖ Verified'; }
      else { kycStatusEl.textContent = 'KYC: ‚è≥ Pending'; }

      tierInfoEl.textContent = `Tier: ${tier}`;

      // Gating rules:
      // Tier 1: allow practice logging without wallet (unlock beforePhoto immediately)
      // Tier 2+: require wallet connect first to unlock beforePhoto
      if (tier < 2) {
        tierNoteEl.textContent = 'Tier 1: You can try the logger now. Earnings queue until you connect a wallet later.';
        beforePhoto.disabled = false;
        beforePhoto.style.opacity = '1';
      } else {
        tierNoteEl.textContent = 'Tier 2+: Connect a wallet to unlock the camera and earn live rewards.';
        beforePhoto.disabled = !walletAddress;
        beforePhoto.style.opacity = walletAddress ? '1' : '0.6';
      }
    });
  </script>

  <!-- iOS wallet-browser helper -->
  <script>
    (function(){
      const isIOS = () => /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      const inWalletWebView = () => /Phantom|Solflare|Backpack|Glow/i.test(navigator.userAgent||'');

      function openInPhantom(){
        const url = window.location.href;
        const scheme = 'phantom://browse/' + encodeURIComponent(url);
        const ulFallback = 'https://phantom.app/ul/browse/' + encodeURIComponent(url);
        const iframe = document.createElement('iframe'); iframe.style.display='none'; iframe.src = scheme; document.body.appendChild(iframe);
        setTimeout(()=>{ window.location.href = ulFallback; }, 800);
        setTimeout(()=>{ try{ document.body.removeChild(iframe);}catch(_){} }, 3000);
      }
      function openInSolflare(){
        const url = window.location.href;
        const scheme = 'solflare://browser?url=' + encodeURIComponent(url);
        const ulFallback = 'https://solflare.com/ul/v1/browse?url=' + encodeURIComponent(url);
        const iframe = document.createElement('iframe'); iframe.style.display='none'; iframe.src = scheme; document.body.appendChild(iframe);
        setTimeout(()=>{ window.location.href = ulFallback; }, 800);
        setTimeout(()=>{ try{ document.body.removeChild(iframe);}catch(_){} }, 3000);
      }
      function copyURL(){
        const url = window.location.href;
        navigator.clipboard?.writeText(url).then(()=>{
          const btn = document.getElementById('copyUrlBtn');
          if (btn){ btn.textContent='Copied ‚úì'; setTimeout(()=> btn.textContent='Copy URL', 1500); }
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        const notice = document.getElementById('iosWalletNotice');
        if (isIOS() && !inWalletWebView()) notice.style.display = 'block';
        document.getElementById('openPhantomBtn')?.addEventListener('click', openInPhantom);
        document.getElementById('openSolflareBtn')?.addEventListener('click', openInSolflare);
        document.getElementById('copyUrlBtn')?.addEventListener('click', copyURL);
      });
    })();
  </script>
</body>
</html>
